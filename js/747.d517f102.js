"use strict";(self["webpackChunkweb"]=self["webpackChunkweb"]||[]).push([[747],{1747:function(t,e,s){s.r(e),s.d(e,{default:function(){return J}});var a=s(6768),o=s(5130),l=s(4232);const n={class:"mb-3"},i={class:"d-flex justify-content-between align-items-center border-bottom pb-2"},r={class:"overflow-y-auto"},d={class:"table align-middle table-hover"},m={class:"fw-bold"},c={class:"text-muted"},u={class:"text-muted"},f={class:"text-muted"},k=["onClick"],b=["onClick"],L={key:0};function h(t,e,s,h,v,p){const g=(0,a.g2)("WorkLogOffcanvas");return(0,a.uX)(),(0,a.CE)(a.FK,null,[(0,a.Lk)("section",n,[(0,a.Lk)("div",i,[e[2]||(e[2]=(0,a.Lk)("h5",{class:"mb-0"},"案件列表",-1)),(0,a.Lk)("a",{href:"#",class:"text-decoration-none",onClick:e[0]||(e[0]=(0,o.D$)((t=>this.$emitter.emit("addEditCase",{isNew:!0})),["prevent"]))},e[1]||(e[1]=[(0,a.eW)(" 新增案件 "),(0,a.Lk)("i",{class:"bi bi-plus-lg"},null,-1)]))])]),(0,a.Lk)("section",r,[(0,a.Lk)("table",d,[e[5]||(e[5]=(0,a.Lk)("thead",{class:"table-primary sticky-top"},[(0,a.Lk)("tr",null,[(0,a.Lk)("th",null,"#"),(0,a.Lk)("th",null,"案件名稱"),(0,a.Lk)("th",null,"合作廠商"),(0,a.Lk)("th",null,"工期"),(0,a.Lk)("th",null,"施工地址"),(0,a.Lk)("th",null,"狀態"),(0,a.Lk)("th",null,"操作")])],-1)),(0,a.Lk)("tbody",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(v.caseList,((s,o)=>((0,a.uX)(),(0,a.CE)("tr",{key:s._id},[(0,a.Lk)("th",null,(0,l.v_)(o+1),1),(0,a.Lk)("td",null,[(0,a.Lk)("div",m,(0,l.v_)(s.name),1),(0,a.Lk)("small",c,"案件編號："+(0,l.v_)(s.code||"-"),1)]),(0,a.Lk)("td",null,[(0,a.Lk)("div",null,(0,l.v_)(s.vendor?.name),1),(0,a.Lk)("small",u,(0,l.v_)(s.vendor?.contactPerson)+" ｜ "+(0,l.v_)(s.vendor?.phone),1)]),(0,a.Lk)("td",null,[(0,a.Lk)("div",null,(0,l.v_)(p.formatDate(s.startDate)),1),(0,a.Lk)("small",f," ～ "+(0,l.v_)(s.endDate?p.formatDate(s.endDate):"未定"),1)]),(0,a.Lk)("td",null,(0,l.v_)(s.address),1),(0,a.Lk)("td",null,[(0,a.Lk)("span",{class:(0,l.C4)(["badge",p.statusClass(s.status)])},(0,l.v_)(p.statusText(s.status)),3)]),(0,a.Lk)("td",null,[(0,a.Lk)("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:e=>t.$emitter.emit("addEditCase",{isNew:!1,data:s})},e[3]||(e[3]=[(0,a.Lk)("i",{class:"bi bi-pencil"},null,-1)]),8,k),(0,a.Lk)("button",{class:"btn btn-sm btn-primary",onClick:e=>t.$emitter.emit("openAddWorkLog",s._id)}," 新增工單 ",8,b)])])))),128)),0===v.caseList.length?((0,a.uX)(),(0,a.CE)("tr",L,e[4]||(e[4]=[(0,a.Lk)("td",{colspan:"7",class:"text-center text-muted py-4"}," 尚未建立任何案件 ",-1)]))):(0,a.Q3)("",!0)])])]),(0,a.bF)(g)],64)}var v=s(8113);const p={class:"offcanvas offcanvas-end",tabindex:"-1",ref:"offcanvasRef"},g={class:"offcanvas-header"},y={class:"offcanvas-body d-flex flex-column"},C={class:"nav nav-tabs mb-3"},T=["onClick"],w={key:0,class:"mb-3"},_={class:"mb-3"},$=["value"],I={class:"row g-2 mb-3"},D={class:"col"},E={class:"col"},x={class:"border-top pt-3 flex-grow-1 overflow-auto"},W={key:0,class:"text-muted"},X={class:"d-flex justify-content-between align-items-start"},S=["onClick"],A={class:"text-muted"};function F(t,e,s,n,i,r){return(0,a.uX)(),(0,a.CE)("div",p,[(0,a.Lk)("div",g,[e[8]||(e[8]=(0,a.Lk)("h5",{class:"offcanvas-title"},"新增工單",-1)),(0,a.Lk)("button",{type:"button",class:"btn-close",onClick:e[0]||(e[0]=(...t)=>r.hide&&r.hide(...t))})]),(0,a.Lk)("div",y,[(0,a.Lk)("ul",C,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.dateTabs,(t=>((0,a.uX)(),(0,a.CE)("li",{class:"nav-item",key:t.key},[(0,a.Lk)("button",{class:(0,l.C4)(["nav-link",{active:i.activeTab===t.key}]),onClick:e=>r.selectTab(t)},(0,l.v_)(t.label),11,T)])))),128))]),"custom"===i.activeTab?((0,a.uX)(),(0,a.CE)("div",w,[(0,a.bo)((0,a.Lk)("input",{type:"date",class:"form-control","onUpdate:modelValue":e[1]||(e[1]=t=>i.form.date=t)},null,512),[[o.Jo,i.form.date]])])):(0,a.Q3)("",!0),(0,a.Lk)("form",{onSubmit:e[7]||(e[7]=(0,o.D$)(((...t)=>r.submit&&r.submit(...t)),["prevent"]))},[(0,a.Lk)("div",_,[e[10]||(e[10]=(0,a.Lk)("label",{class:"form-label"},"員工",-1)),(0,a.bo)((0,a.Lk)("select",{class:"form-select","onUpdate:modelValue":e[2]||(e[2]=t=>i.form.employeeId=t),required:""},[e[9]||(e[9]=(0,a.Lk)("option",{value:""},"請選擇員工",-1)),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.employeeList,(t=>((0,a.uX)(),(0,a.CE)("option",{key:t._id,value:t._id},(0,l.v_)(t.name),9,$)))),128))],512),[[o.u1,i.form.employeeId]])]),(0,a.Lk)("div",I,[(0,a.Lk)("div",D,[e[11]||(e[11]=(0,a.Lk)("label",{class:"form-label"},"開始時間",-1)),(0,a.bo)((0,a.Lk)("input",{type:"time",class:"form-control",step:"1800",onBlur:e[3]||(e[3]=t=>i.form.startTime=r.normalizeTime(i.form.startTime)),"onUpdate:modelValue":e[4]||(e[4]=t=>i.form.startTime=t),required:""},null,544),[[o.Jo,i.form.startTime]])]),(0,a.Lk)("div",E,[e[12]||(e[12]=(0,a.Lk)("label",{class:"form-label"},"結束時間",-1)),(0,a.bo)((0,a.Lk)("input",{type:"time",class:"form-control",step:"1800",onBlur:e[5]||(e[5]=t=>i.form.endTime=r.normalizeTime(i.form.endTime)),"onUpdate:modelValue":e[6]||(e[6]=t=>i.form.endTime=t),required:""},null,544),[[o.Jo,i.form.endTime]])])]),e[13]||(e[13]=(0,a.Lk)("div",{class:"d-grid mb-3"},[(0,a.Lk)("button",{class:"btn btn-primary",type:"submit"},"儲存工單")],-1))],32),(0,a.Lk)("div",x,[e[15]||(e[15]=(0,a.Lk)("h6",{class:"mb-3"},"當日工單",-1)),0===i.workLogList.length?((0,a.uX)(),(0,a.CE)("div",W,"尚無工單")):(0,a.Q3)("",!0),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.workLogList,(t=>((0,a.uX)(),(0,a.CE)("div",{key:t._id,class:"border rounded p-2 mb-2"},[(0,a.Lk)("div",X,[(0,a.Lk)("strong",null,(0,l.v_)(t.employee.name),1),(0,a.Lk)("button",{class:"btn btn-sm btn-outline-danger",onClick:e=>r.deleteLog(t)},e[14]||(e[14]=[(0,a.Lk)("i",{class:"bi bi-trash"},null,-1)]),8,S)]),(0,a.Lk)("div",A,(0,l.v_)(t.startTime)+" - "+(0,l.v_)(t.endTime),1)])))),128))])])],512)}var U=s(8077),K={name:"AddWorkLogOffcanvas",data(){return{offcanvas:null,caseId:null,employeeList:[],workLogList:[],activeTab:"today",dateTabs:[{key:"today",label:"今天",offset:0},{key:"yesterday",label:"昨天",offset:-1},{key:"tomorrow",label:"明天",offset:1},{key:"custom",label:"自選日期"}],form:{employeeId:"",date:"",startTime:"",endTime:""}}},watch:{"form.date":function(){this.loadWorkLogs()}},methods:{formatDate(t=0){const e=new Date;e.setDate(e.getDate()+t);const s=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${s}-${a}-${o}`},selectTab(t){console.log("[selectTab] tab:",t),this.activeTab=t.key,void 0!==t.offset&&(this.form.date=this.formatDate(t.offset)),console.log("[selectTab] after set, form.date =",this.form.date),this.loadWorkLogs()},async loadEmployees(){const t=await(0,v.o)();this.employeeList=t.data},async loadWorkLogs(){if(console.log("[loadWorkLogs] caseId:",this.caseId),console.log("[loadWorkLogs] date:",this.form.date),!this.caseId||!this.form.date)return;const t=await(0,v.mf)({caseId:this.caseId,date:this.form.date});console.log("[loadWorkLogs] response:",t.data),this.workLogList=t.data},async submit(){try{await(0,v.Qb)({employee:this.form.employeeId,caseId:this.caseId,date:this.form.date,startTime:this.form.startTime,endTime:this.form.endTime}),this.$emitter.emit("messageModal",{status:!0,message:"新增工單成功"}),this.form.startTime="",this.form.endTime="",await this.loadWorkLogs()}catch(t){this.$emitter.emit("messageModal",{status:!1,message:t.response?.data?.error||"新增失敗"})}},async deleteLog(t){confirm("確定要刪除這筆工單？")&&(await(0,v.Pf)(t._id),await this.loadWorkLogs())},show(t){this.caseId=t,this.activeTab="today",this.form.date=this.formatDate(0),this.form.employeeId="",this.form.startTime="",this.form.endTime="",this.loadEmployees(),this.loadWorkLogs(),this.offcanvas.show()},hide(){this.offcanvas.hide()},normalizeTime(t){if(!t)return"";const[e,s]=t.split(":").map(Number);let a=e;const o=s<15?0:s<45?30:0;return s>=45&&(a=(e+1)%24),`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`}},mounted(){this.offcanvas=new U.go(this.$refs.offcanvasRef),this.$emitter.on("openAddWorkLog",this.show)},beforeUnmount(){this.$emitter.off("openAddWorkLog",this.show)}},V=s(1241);const M=(0,V.A)(K,[["render",F]]);var Q=M,q={name:"CaseView",data(){return{caseList:[]}},components:{WorkLogOffcanvas:Q},methods:{async getCases(){this.$emitter.emit("loadingStatus",!0);try{const t=await(0,v.Ac)();this.caseList=t.data}catch(t){console.error(t),this.$emitter.emit("messageModal",{status:!1,message:"取得案件失敗"})}finally{this.$emitter.emit("loadingStatus",!1)}},formatDate(t){return t?new Date(t).toLocaleDateString():"-"},statusText(t){const e={planning:"規劃中",in_progress:"施工中",paused:"暫停",completed:"已完工",cancelled:"已取消"};return e[t]||t},statusClass(t){const e={planning:"bg-secondary",in_progress:"bg-primary",paused:"bg-warning",completed:"bg-success",cancelled:"bg-dark"};return e[t]||"bg-secondary"}},mounted(){this.getCases(),this.$emitter.on("refreshCaseList",(()=>{this.getCases()}))},beforeUnmount(){this.$emitter.off("refreshCaseList")}};const z=(0,V.A)(q,[["render",h]]);var J=z}}]);
//# sourceMappingURL=747.d517f102.js.map